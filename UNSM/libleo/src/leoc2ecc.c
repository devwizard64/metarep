#include <ultra64.h>
#include <PR/leoappli.h>
#include "leoint.h"

struct block_param_form LEOc2_param;

static const unsigned char ganlog[] =
{
0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80,0x1D,0x3A,0x74,0xE8,0xCD,0x87,0x13,0x26,
0x4C,0x98,0x2D,0x5A,0xB4,0x75,0xEA,0xC9,0x8F,0x03,0x06,0x0C,0x18,0x30,0x60,0xC0,
0x9D,0x27,0x4E,0x9C,0x25,0x4A,0x94,0x35,0x6A,0xD4,0xB5,0x77,0xEE,0xC1,0x9F,0x23,
0x46,0x8C,0x05,0x0A,0x14,0x28,0x50,0xA0,0x5D,0xBA,0x69,0xD2,0xB9,0x6F,0xDE,0xA1,
0x5F,0xBE,0x61,0xC2,0x99,0x2F,0x5E,0xBC,0x65,0xCA,0x89,0x0F,0x1E,0x3C,0x78,0xF0,
0xFD,0xE7,0xD3,0xBB,0x6B,0xD6,0xB1,0x7F,0xFE,0xE1,0xDF,0xA3,0x5B,0xB6,0x71,0xE2,
0xD9,0xAF,0x43,0x86,0x11,0x22,0x44,0x88,0x0D,0x1A,0x34,0x68,0xD0,0xBD,0x67,0xCE,
0x81,0x1F,0x3E,0x7C,0xF8,0xED,0xC7,0x93,0x3B,0x76,0xEC,0xC5,0x97,0x33,0x66,0xCC,
0x85,0x17,0x2E,0x5C,0xB8,0x6D,0xDA,0xA9,0x4F,0x9E,0x21,0x42,0x84,0x15,0x2A,0x54,
0xA8,0x4D,0x9A,0x29,0x52,0xA4,0x55,0xAA,0x49,0x92,0x39,0x72,0xE4,0xD5,0xB7,0x73,
0xE6,0xD1,0xBF,0x63,0xC6,0x91,0x3F,0x7E,0xFC,0xE5,0xD7,0xB3,0x7B,0xF6,0xF1,0xFF,
0xE3,0xDB,0xAB,0x4B,0x96,0x31,0x62,0xC4,0x95,0x37,0x6E,0xDC,0xA5,0x57,0xAE,0x41,
0x82,0x19,0x32,0x64,0xC8,0x8D,0x07,0x0E,0x1C,0x38,0x70,0xE0,0xDD,0xA7,0x53,0xA6,
0x51,0xA2,0x59,0xB2,0x79,0xF2,0xF9,0xEF,0xC3,0x9B,0x2B,0x56,0xAC,0x45,0x8A,0x09,
0x12,0x24,0x48,0x90,0x3D,0x7A,0xF4,0xF5,0xF7,0xF3,0xFB,0xEB,0xCB,0x8B,0x0B,0x16,
0x2C,0x58,0xB0,0x7D,0xFA,0xE9,0xCF,0x83,0x1B,0x36,0x6C,0xD8,0xAD,0x47,0x8E,0x01,
0x02,0x04,0x08,0x10,0x20,0x40,0x80,0x1D,0x3A,0x74,0xE8,0xCD,0x87,0x13,0x26,0x4C,
0x98,0x2D,0x5A,0xB4,0x75,0xEA,0xC9,0x8F,0x03,0x06,0x0C,0x18,0x30,0x60,0xC0,0x9D,
0x27,0x4E,0x9C,0x25,0x4A,0x94,0x35,0x6A,0xD4,0xB5,0x77,0xEE,0xC1,0x9F,0x23,0x46,
0x8C,0x05,0x0A,0x14,0x28,0x50,0xA0,0x5D,0xBA,0x69,0xD2,0xB9,0x6F,0xDE,0xA1,0x5F,
0xBE,0x61,0xC2,0x99,0x2F,0x5E,0xBC,0x65,0xCA,0x89,0x0F,0x1E,0x3C,0x78,0xF0,0xFD,
0xE7,0xD3,0xBB,0x6B,0xD6,0xB1,0x7F,0xFE,0xE1,0xDF,0xA3,0x5B,0xB6,0x71,0xE2,0xD9,
0xAF,0x43,0x86,0x11,0x22,0x44,0x88,0x0D,0x1A,0x34,0x68,0xD0,0xBD,0x67,0xCE,0x81,
0x1F,0x3E,0x7C,0xF8,0xED,0xC7,0x93,0x3B,0x76,0xEC,0xC5,0x97,0x33,0x66,0xCC,0x85,
0x17,0x2E,0x5C,0xB8,0x6D,0xDA,0xA9,0x4F,0x9E,0x21,0x42,0x84,0x15,0x2A,0x54,0xA8,
0x4D,0x9A,0x29,0x52,0xA4,0x55,0xAA,0x49,0x92,0x39,0x72,0xE4,0xD5,0xB7,0x73,0xE6,
0xD1,0xBF,0x63,0xC6,0x91,0x3F,0x7E,0xFC,0xE5,0xD7,0xB3,0x7B,0xF6,0xF1,0xFF,0xE3,
0xDB,0xAB,0x4B,0x96,0x31,0x62,0xC4,0x95,0x37,0x6E,0xDC,0xA5,0x57,0xAE,0x41,0x82,
0x19,0x32,0x64,0xC8,0x8D,0x07,0x0E,0x1C,0x38,0x70,0xE0,0xDD,0xA7,0x53,0xA6,0x51,
0xA2,0x59,0xB2,0x79,0xF2,0xF9,0xEF,0xC3,0x9B,0x2B,0x56,0xAC,0x45,0x8A,0x09,0x12,
0x24,0x48,0x90,0x3D,0x7A,0xF4,0xF5,0xF7,0xF3,0xFB,0xEB,0xCB,0x8B,0x0B,0x16,0x2C,
0x58,0xB0,0x7D,0xFA,0xE9,0xCF,0x83,0x1B,0x36,0x6C,0xD8,0xAD,0x47,0x8E,0x01,0x02,
};

static const unsigned char glog[] =
{
0x00,0x00,0x01,0x19,0x02,0x32,0x1A,0xC6,0x03,0xDF,0x33,0xEE,0x1B,0x68,0xC7,0x4B,
0x04,0x64,0xE0,0x0E,0x34,0x8D,0xEF,0x81,0x1C,0xC1,0x69,0xF8,0xC8,0x08,0x4C,0x71,
0x05,0x8A,0x65,0x2F,0xE1,0x24,0x0F,0x21,0x35,0x93,0x8E,0xDA,0xF0,0x12,0x82,0x45,
0x1D,0xB5,0xC2,0x7D,0x6A,0x27,0xF9,0xB9,0xC9,0x9A,0x09,0x78,0x4D,0xE4,0x72,0xA6,
0x06,0xBF,0x8B,0x62,0x66,0xDD,0x30,0xFD,0xE2,0x98,0x25,0xB3,0x10,0x91,0x22,0x88,
0x36,0xD0,0x94,0xCE,0x8F,0x96,0xDB,0xBD,0xF1,0xD2,0x13,0x5C,0x83,0x38,0x46,0x40,
0x1E,0x42,0xB6,0xA3,0xC3,0x48,0x7E,0x6E,0x6B,0x3A,0x28,0x54,0xFA,0x85,0xBA,0x3D,
0xCA,0x5E,0x9B,0x9F,0x0A,0x15,0x79,0x2B,0x4E,0xD4,0xE5,0xAC,0x73,0xF3,0xA7,0x57,
0x07,0x70,0xC0,0xF7,0x8C,0x80,0x63,0x0D,0x67,0x4A,0xDE,0xED,0x31,0xC5,0xFE,0x18,
0xE3,0xA5,0x99,0x77,0x26,0xB8,0xB4,0x7C,0x11,0x44,0x92,0xD9,0x23,0x20,0x89,0x2E,
0x37,0x3F,0xD1,0x5B,0x95,0xBC,0xCF,0xCD,0x90,0x87,0x97,0xB2,0xDC,0xFC,0xBE,0x61,
0xF2,0x56,0xD3,0xAB,0x14,0x2A,0x5D,0x9E,0x84,0x3C,0x39,0x53,0x47,0x6D,0x41,0xA2,
0x1F,0x2D,0x43,0xD8,0xB7,0x7B,0xA4,0x76,0xC4,0x17,0x49,0xEC,0x7F,0x0C,0x6F,0xF6,
0x6C,0xA1,0x3B,0x52,0x29,0x9D,0x55,0xAA,0xFB,0x60,0x86,0xB1,0xBB,0xCC,0x3E,0x5A,
0xCB,0x59,0x5F,0xB0,0x9C,0xA9,0xA0,0x51,0x0B,0xF5,0x16,0xEB,0x7A,0x75,0x2C,0xD7,
0x4F,0xAE,0xD5,0xE9,0xE6,0xE7,0xAD,0xE8,0x74,0xD6,0xF4,0xEA,0xA8,0x50,0x58,0xAF,
0xFF,0x01,0x19,0x02,0x32,0x1A,0xC6,0x03,0xDF,0x33,0xEE,0x1B,0x68,0xC7,0x4B,0x04,
0x64,0xE0,0x0E,0x34,0x8D,0xEF,0x81,0x1C,0xC1,0x69,0xF8,0xC8,0x08,0x4C,0x71,0x05,
0x8A,0x65,0x2F,0xE1,0x24,0x0F,0x21,0x35,0x93,0x8E,0xDA,0xF0,0x12,0x82,0x45,0x1D,
0xB5,0xC2,0x7D,0x6A,0x27,0xF9,0xB9,0xC9,0x9A,0x09,0x78,0x4D,0xE4,0x72,0xA6,0x06,
0xBF,0x8B,0x62,0x66,0xDD,0x30,0xFD,0xE2,0x98,0x25,0xB3,0x10,0x91,0x22,0x88,0x36,
0xD0,0x94,0xCE,0x8F,0x96,0xDB,0xBD,0xF1,0xD2,0x13,0x5C,0x83,0x38,0x46,0x40,0x1E,
0x42,0xB6,0xA3,0xC3,0x48,0x7E,0x6E,0x6B,0x3A,0x28,0x54,0xFA,0x85,0xBA,0x3D,0xCA,
0x5E,0x9B,0x9F,0x0A,0x15,0x79,0x2B,0x4E,0xD4,0xE5,0xAC,0x73,0xF3,0xA7,0x57,0x07,
0x70,0xC0,0xF7,0x8C,0x80,0x63,0x0D,0x67,0x4A,0xDE,0xED,0x31,0xC5,0xFE,0x18,0xE3,
0xA5,0x99,0x77,0x26,0xB8,0xB4,0x7C,0x11,0x44,0x92,0xD9,0x23,0x20,0x89,0x2E,0x37,
0x3F,0xD1,0x5B,0x95,0xBC,0xCF,0xCD,0x90,0x87,0x97,0xB2,0xDC,0xFC,0xBE,0x61,0xF2,
0x56,0xD3,0xAB,0x14,0x2A,0x5D,0x9E,0x84,0x3C,0x39,0x53,0x47,0x6D,0x41,0xA2,0x1F,
0x2D,0x43,0xD8,0xB7,0x7B,0xA4,0x76,0xC4,0x17,0x49,0xEC,0x7F,0x0C,0x6F,0xF6,0x6C,
0xA1,0x3B,0x52,0x29,0x9D,0x55,0xAA,0xFB,0x60,0x86,0xB1,0xBB,0xCC,0x3E,0x5A,0xCB,
0x59,0x5F,0xB0,0x9C,0xA9,0xA0,0x51,0x0B,0xF5,0x16,0xEB,0x7A,0x75,0x2C,0xD7,0x4F,
0xAE,0xD5,0xE9,0xE6,0xE7,0xAD,0xE8,0x74,0xD6,0xF4,0xEA,0xA8,0x50,0x58,0xAF,0xFF,
};

static void leoC2_single_ecc(void);
static void leoC2_double_ecc(void);
static void leoC2_3_ecc(void);
static void leoC2_4_ecc(void);
static int leoAlpha_mult(int i, int k);
static int leoAlpha_div(int i, int k);

int leoC2_Correction(void)
{
	switch (LEOc2_param.err_num)
	{
	case 0: break;
	case 1: leoC2_single_ecc(); break;
	case 2: leoC2_double_ecc(); break;
	case 3: leoC2_3_ecc(); break;
	case 4: leoC2_4_ecc(); break;
	default: return 0xFFFF;
	}
	return 0;
}

static void leoC2_single_ecc(void)
{
	u8 *p;
	u32 bytes;
	u8 *c2;
	if (LEOc2_param.err_pos[0] >= 85) return;
	bytes = LEOc2_param.bytes;
	p = (LEOc2_param.err_pos[0]+1)*bytes + LEOc2_param.pntr;
	c2 = LEOc2_param.c2buff_e;
	do {*--p ^= *(c2 -= 4);} while (--bytes);
}

static void leoC2_double_ecc(void)
{
	register u32 s0, s1;
	u8 *p1, *p2;
	u32 e1, e2, f, d;
	u32 bytes;
	u8 *c2;
	e1 = 85+4-1 - LEOc2_param.err_pos[0];
	e2 = 85+4-1 - LEOc2_param.err_pos[1];
	d = ganlog[e1] ^ ganlog[e2];
	d = glog[leoAlpha_div(1, d)];
	bytes = LEOc2_param.bytes;
	if (LEOc2_param.err_pos[1] < 85) goto c2_2_2;
	p2 = &LEO_TempBuffer[232];
	if (LEOc2_param.err_pos[0] < 85) goto c2_2_1;
	return;
c2_2_2: p2 = (LEOc2_param.err_pos[1]+1)*bytes + LEOc2_param.pntr;
c2_2_1: p1 = (LEOc2_param.err_pos[0]+1)*bytes + LEOc2_param.pntr;
	c2 = LEOc2_param.c2buff_e;
	do
	{
		if ((s0 = *(c2 -= 4)))  f = ganlog[e2+glog[s0]] ^ *(c2+1);
		else                    f = *(c2+1);
		p1--;
		p2--;
		if (f)
		{
			s1 = ganlog[glog[f]+d];
			*p1 ^= s1;
			*p2 ^= s1 ^ s0;
		}
		else
		{
			*p2 ^= s0;
		}
	}
	while (--bytes);
}

static void leoC2_3_ecc(void)
{
	register u32 s0, s1, s2, s3;
	u8 *p1, *p2, *p3;
	u32 bytes;
	u32 e1, e2, e3, f1, f2, f3, g1, g2, g3, h1, h2, h3, d;
	u8 *c2;
	e1 = 85+4-1 - LEOc2_param.err_pos[0];
	e2 = 85+4-1 - LEOc2_param.err_pos[1];
	e3 = 85+4-1 - LEOc2_param.err_pos[2];
	e1 = ganlog[e1];
	e2 = ganlog[e2];
	e3 = ganlog[e3];
	f1 = leoAlpha_mult(e3, e3);
	f2 = leoAlpha_mult(e2, e2);
	f3 = leoAlpha_mult(e1, e1);
	g1 = f1^f2;
	g2 = f1^f3;
	g3 = f2^f3;
	h1 = leoAlpha_mult(e2, f1) ^ leoAlpha_mult(e3, f2);
	h2 = leoAlpha_mult(e3, f3) ^ leoAlpha_mult(e1, f1);
	h3 = leoAlpha_mult(e2, f3) ^ leoAlpha_mult(e1, f2);
	f1 = e2^e3;
	f2 = e3^e1;
	f3 = e1^e2;
	d = h1^h2^h3;
	d = leoAlpha_div(1, d);
	h1 = glog[h1];
	g1 = glog[g1];
	f1 = glog[f1];
	g2 = glog[g2];
	h2 = glog[h2];
	f2 = glog[f2];
	h3 = glog[h3];
	g3 = glog[g3];
	f3 = glog[f3];
	d = glog[d];
	bytes = LEOc2_param.bytes;
	if (LEOc2_param.err_pos[2] < 85) goto c2_3_3;
	p3 = &LEO_TempBuffer[232];
	if (LEOc2_param.err_pos[1] < 85) goto c2_3_2;
	p2 = &LEO_TempBuffer[232];
	if (LEOc2_param.err_pos[0] < 85) goto c2_3_1;
	return;
c2_3_3: p3 = (LEOc2_param.err_pos[2]+1)*bytes + LEOc2_param.pntr;
c2_3_2: p2 = (LEOc2_param.err_pos[1]+1)*bytes + LEOc2_param.pntr;
c2_3_1: p1 = (LEOc2_param.err_pos[0]+1)*bytes + LEOc2_param.pntr;
	c2 = LEOc2_param.c2buff_e;
	do
	{
		if ((s0 = *(c2 -= 4)))
		{
			s0 = glog[s0];
			s1 = ganlog[s0+h1];
			s2 = ganlog[s0+h2];
			s3 = ganlog[s0+h3];
		}
		else
		{
			s1 = s2 = s3 = 0;
		}
		if ((s0 = *(c2+1)))
		{
			s0 = glog[s0];
			s1 ^= ganlog[s0+g1];
			s2 ^= ganlog[s0+g2];
			s3 ^= ganlog[s0+g3];
		}
		if ((s0 = *(c2+2)))
		{
			s0 = glog[s0];
			s1 ^= ganlog[s0+f1];
			s2 ^= ganlog[s0+f2];
			s3 ^= ganlog[s0+f3];
		}
		p1--;
		p2--;
		p3--;
		if (s1) *p1 ^= ganlog[glog[s1]+d];
		if (s2) *p2 ^= ganlog[glog[s2]+d];
		if (s3) *p3 ^= ganlog[glog[s3]+d];
	}
	while (--bytes);
}

#define DIV(e, x) leoAlpha_div(e, x)^1
#define MULDIV3(e, x, y, z) \
	leoAlpha_mult(leoAlpha_mult(DIV(e, x), DIV(e, y)), DIV(e, z))

static void leoC2_4_ecc(void)
{
	register u32 s0, s1, s2, s3, s4;
	u8 *p1, *p2, *p3, *p4;
	u32 f1, f2, f4, f3, f5, f6, f7, f8, e4, e1, e2, e3;
	u32 bytes;
	u32 d1, g1, g2, g3, g4, h1, h2, h3, h4;
	u32 d2, d3, d4, k1, k2, k3, k4;
	u8 *c2;
	e1 = 85+4-1 - LEOc2_param.err_pos[0];
	e2 = 85+4-1 - LEOc2_param.err_pos[1];
	e3 = 85+4-1 - LEOc2_param.err_pos[2];
	e4 = 85+4-1 - LEOc2_param.err_pos[3];
	e1 = ganlog[e1];
	e2 = ganlog[e2];
	e3 = ganlog[e3];
	e4 = ganlog[e4];
	d1 = ganlog[0];
	f1 = leoAlpha_div(d1, e1);
	f2 = leoAlpha_div(d1, e2);
	f3 = leoAlpha_div(d1, e3);
	f4 = leoAlpha_div(d1, e4);
	g1 = leoAlpha_mult(f2, f3);
	g2 = leoAlpha_mult(f3, f4);
	g3 = leoAlpha_mult(f4, f2);
	g4 = leoAlpha_mult(f4, f1);
	h1 = leoAlpha_mult(f1, f3);
	h2 = leoAlpha_mult(f1, f2);
	k1 = g1^g2^g3;
	k2 = g2^g4^h1;
	k3 = g4^h2^g3;
	k4 = h2^g1^h1;
	g1 = f2^f3^f4;
	g2 = f3^f4^f1;
	g3 = f4^f1^f2;
	g4 = f1^f2^f3;
	h1 = leoAlpha_mult(leoAlpha_mult(f2, f3), f4);
	h2 = leoAlpha_mult(leoAlpha_mult(f3, f4), f1);
	h3 = leoAlpha_mult(leoAlpha_mult(f4, f1), f2);
	h4 = leoAlpha_mult(leoAlpha_mult(f1, f2), f3);
	d1 = MULDIV3(e1, e2, e3, e4);
	d1 = leoAlpha_div(1, d1);
	d2 = MULDIV3(e2, e1, e3, e4);
	d2 = leoAlpha_div(1, d2);
	d3 = MULDIV3(e3, e1, e2, e4);
	d3 = leoAlpha_div(1, d3);
	d4 = MULDIV3(e4, e1, e2, e3);
	d4 = leoAlpha_div(1, d4);
	f1 = glog[leoAlpha_mult(g1, d1)];
	f2 = glog[leoAlpha_mult(k1, d1)];
	h1 = leoAlpha_mult(h1, d1);
	f3 = glog[leoAlpha_mult(g2, d2)];
	f4 = glog[leoAlpha_mult(k2, d2)];
	h2 = leoAlpha_mult(h2, d2);
	f5 = glog[leoAlpha_mult(g3, d3)];
	f6 = glog[leoAlpha_mult(k3, d3)];
	h3 = leoAlpha_mult(h3, d3);
	f7 = glog[leoAlpha_mult(g4, d4)];
	f8 = glog[leoAlpha_mult(k4, d4)];
	h4 = leoAlpha_mult(h4, d4);
	d1 = glog[d1];
	h1 = glog[h1];
	d2 = glog[d2];
	h2 = glog[h2];
	d3 = glog[d3];
	h3 = glog[h3];
	d4 = glog[d4];
	h4 = glog[h4];
	bytes = LEOc2_param.bytes;
	if (LEOc2_param.err_pos[3] < 85) goto c2_4_4;
	p4 = &LEO_TempBuffer[232];
	if (LEOc2_param.err_pos[2] < 85) goto c2_4_3;
	p3 = &LEO_TempBuffer[232];
	if (LEOc2_param.err_pos[1] < 85) goto c2_4_2;
	p2 = &LEO_TempBuffer[232];
	if (LEOc2_param.err_pos[0] < 85) goto c2_4_1;
	return;
c2_4_4: p4 = (LEOc2_param.err_pos[3]+1)*bytes + LEOc2_param.pntr;
c2_4_3: p3 = (LEOc2_param.err_pos[2]+1)*bytes + LEOc2_param.pntr;
c2_4_2: p2 = (LEOc2_param.err_pos[1]+1)*bytes + LEOc2_param.pntr;
c2_4_1: p1 = (LEOc2_param.err_pos[0]+1)*bytes + LEOc2_param.pntr;
	c2 = LEOc2_param.c2buff_e;
	do
	{
		if (!(s0 = *(c2 -= 4)))
		{
			s1 = s2 = s3 = s4 = 0;
		}
		else
		{
			s0 = glog[s0];
			s1 = ganlog[s0+d1];
			s2 = ganlog[s0+d2];
			s3 = ganlog[s0+d3];
			s4 = ganlog[s0+d4];
		}
		if ((s0 = *(c2+1)))
		{
			s0 = glog[s0];
			s1 ^= g1 == 0 ? 0 : ganlog[s0+f1];
			s2 ^= g2 == 0 ? 0 : ganlog[s0+f3];
			s3 ^= g3 == 0 ? 0 : ganlog[s0+f5];
			s4 ^= g4 == 0 ? 0 : ganlog[s0+f7];
		}
		if ((s0 = *(c2+2)))
		{
			s0 = glog[s0];
			s1 ^= k1 == 0 ? 0 : ganlog[s0+f2];
			s2 ^= k2 == 0 ? 0 : ganlog[s0+f4];
			s3 ^= k3 == 0 ? 0 : ganlog[s0+f6];
			s4 ^= k4 == 0 ? 0 : ganlog[s0+f8];
		}
		if ((s0 = *(c2+3)))
		{
			s0 = glog[s0];
			s1 ^= ganlog[s0+h1];
			s2 ^= ganlog[s0+h2];
			s3 ^= ganlog[s0+h3];
			s4 ^= ganlog[s0+h4];
		}
		p1--;
		p2--;
		p3--;
		p4--;
		if (s1) *p1 ^= s1;
		if (s2) *p2 ^= s2;
		if (s3) *p3 ^= s3;
		if (s4) *p4 ^= s4;
	}
	while (--bytes);
}

static int leoAlpha_mult(int i, int k)
{
	if (i == 0 || k == 0) return 0;
	else return ganlog[glog[i]+glog[k]];
}

static int leoAlpha_div(int i, int k)
{
	if (i == 0 || k == 0) return 0;
	return ganlog[255+glog[i]-glog[k]];
}
